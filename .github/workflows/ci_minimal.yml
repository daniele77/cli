name: CI windows

on: [push,pull_request]

jobs:
  Test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false

      matrix:
        os: [windows-2025]
        compiler: [msvc]
        standard: [23]
        build_type: [Release]

    steps:
    - uses: actions/checkout@v4

    - name: Setup Cpp
      uses: aminya/setup-cpp@v1
      with:
        compiler: ${{ matrix.compiler }}
        vcvarsall: ${{ contains(matrix.os, 'windows' )}}

        cmake: true
        ninja: true
        vcpkg: false
        ccache: true
        clangtidy: true

        cppcheck: true

        gcovr: true
        opencppcoverage: true

    - name: setup dependencies - Windows
      run: |
          choco install ninja
          choco install boost-msvc-14.1

          # Stampa la directory 'lib' di choco per debug
          echo "Contenuto di C:\ProgramData\chocolatey\lib:"
          dir C:\ProgramData\chocolatey\lib

          # Download and extract Asio
          curl -L -o asio.zip https://github.com/chriskohlhoff/asio/archive/refs/tags/asio-1-18-2.zip
          tar -xf asio.zip
          move asio-asio-1-18-2 asio

    - name: Configure CMake - Windows
      # windows need asio library path
      run: |
        Start-Sleep -Seconds 2

        # Correctly constructs the path for Windows
        $AsioPath = Join-Path $env:GITHUB_WORKSPACE "asio/asio/include"
        # Converts to forward slash (CMake handles them better)
        $AsioPath = $AsioPath -replace "\\", "/"

        echo "ASIO path: $AsioPath"
        dir $AsioPath

        cmake -S . -B ./build `
          -DCMAKE_BUILD_TYPE:STRING=${{ matrix.build_type }} `
          -DCMAKE_CXX_STANDARD=${{ matrix.standard }} `
          -DCLI_BuildTests=ON `
          -DCLI_BuildExamples=ON `
          -DCLI_UseBoostAsio=ON `
          -DASIO_INCLUDEDIR="$AsioPath"

    - name: Set Boost DLL Path - Windows ✨ (Fix finale)
      if: runner.os == 'Windows'
      run: |
            # 1. Trova la directory root di Boost (usando il nome esatto del pacchetto da Chocolatey)
            $boostRoot = Get-ChildItem -Path "C:\ProgramData\chocolatey\lib\boost-msvc-14.1" -Directory -ErrorAction Stop
            
            # 2. Ricerca Ricorsiva Aggressiva delle DLL.
            # Le DLL Boost sono spesso in una sottocartella che riflette il toolset MSVC, es. 'lib\x64' o 'lib-vc141-mt-x64'.
            # Cerchiamo qualsiasi file .dll sotto la root di Boost.
            $boostDllFile = Get-ChildItem -Path "$($boostRoot.FullName)" -Filter "*.dll" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
            
            if ($null -eq $boostDllFile) {
                # Write-Error "ERRORE CRITICO: Nessun file DLL di Boost trovato sotto la directory: $($boostRoot.FullName)"
                # Aggiungiamo un debug per vedere cosa c'è nella cartella root di Boost
                Write-Host "Contenuto della cartella Boost:"
                Get-ChildItem -Path "$($boostRoot.FullName)" -Recurse
                exit 1
            }
    
            # 3. Aggiungi il percorso PATH
            $dllPath = $boostDllFile.Directory.FullName
            echo "Aggiungo il percorso delle DLL di Boost: $dllPath"
            # Aggiunge il percorso alla variabile d'ambiente PATH per i successivi step
            echo "$dllPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding UTF8 -Append

    - name: Build
      run: |
        cmake --build ./build --config ${{matrix.build_type}}

    - name: run tests
      working-directory: ./build
      run: |
        ctest -C ${{matrix.build_type}} --output-on-failure
